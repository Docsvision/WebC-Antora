= Включить предпросмотр файлов при помощи Р7-Офис/OnlyOffice

По умолчанию предпросмотр документов в ЭУ `_Предпросмотр файла_` отключен, его можно активировать, настроив компоненты Р7-Офис Сервер документов/OnlyOffice.

Данная реализация позволяет отображать предпросмотр непосредственно файла. Например, для документа Excel появляется возможность скопировать данные из файла с сохранением структуры и форматирования. Все прежние функции поддерживаются как в стандартной реализации.

[#setup]
== Настройка "Р7-Офис. Сервер документов"/OnlyOffice

.Чтобы активировать новый режим предварительного просмотра, выполните шаги следующей инструкции:
. Скачайте и установите сервер документов https://r7-office.ru/downloadserver_doc[по ссылке]. Инструкция по установке доступна по той же ссылке.
+
.Достаточно установить только следующие компоненты:
* http://www.erlang.org/patches/otp-19.1[Erlang].
* http://github.com/rabbitmq/rabbitmq-server/releases/tag/rabbitmq_v3_5_4[RabbitMQ].
* http://www.enterprisedb.com/downloads/postgres-postgresql-downloads[PostgreSQL].
* https://github.com/tporadowski/redis/releases[Redis].
+
Указанные компоненты можно установить через инсталлятор, сам корпоративный сервер устанавливать не требуется.
+
. Создайте новый сертификат сервера при помощи утилиты
// tag::cert-iis[]
. Откройте диспетчер серверов IIS. На начальной странице выберите _Сертификаты сервера_.
+
.Начальная страница диспетчера серверов IIS
image::webclient:admin:server-certificates.png[Начальная страница диспетчера серверов IIS]
+
. На странице _Сертификаты сервера_ выберите *Создать самозаверенный сертификат*.
+
."Создать самозаверенный сертификат"
image::webclient:admin:self-signed.png["Создать самозаверенный сертификат"]
+
. В поле _Понятное имя сертификата_ укажите полное имя сервера, затем нажмите *ОК*.
+
.Укажите имя сертификата
image::cert-name.png[Укажите имя сертификата]
+
. Правой кнопкой мыши нажмите на созданный сертификат, в контекстном меню выберите _Экспортировать_.
+
.Экспортируйте сертификат
image::cert-export.png[Экспортируйте сертификат]
+
. В появившемся окне укажите путь для сохранения сертификата и задайте пароль.
+
.Укажите путь для сохранения сертификата и задайте пароль
image::cert-creds.png[Укажите путь для сохранения сертификата и задайте пароль]
// end::cert-iis[]
+
. Скачайте и установите утилиту https://slproweb.com/products/Win32OpenSSL.html[OpenSSL].
. Запустите Win64 OpenSSL Command Prompt от имени администратора, перейдите в директорию, в которой располагается файл `r7-cert.pfx`
. Выполните команду:
+
 $ openssl pkcs12 -in ./r7cert.pfx -clcerts -nokeys -out r7cert.crt
+
В процессе создания сертификата будет предложено задать пароль для сертификата.
+
Будет создан файл `r7cert.crt`.
+
. Выполните команду:
+
 $ openssl pkcs12 -in ./r7cert.pfx -nocerts -nodes -out r7cert.key
+
Утилита запросит пароль на сертификат и на файл `.pfx`.
+
Будет создан файл `r7cert.key`.
+
. В файле `ds.conf` по адресу `C:\Program Files\R7-Office\DocumentServer-IE\nginx\conf` укажите путь до созданных сертификата и ключа по следующему шаблону:
+
[source]
----
include includes/http-common.conf;
server {
listen 0.0.0.0:8083 ssl; <.>
listen [::]:8083 ssl default_server;
server_tokens off;

set $secure_link_secret oLERiDD4bc309MFWvy3B;
root /usr/share/nginx/html;

ssl on;
ssl_certificate "C:/certificates/r7test.crt"; <.>
ssl_certificate_key "C:/certificates/r7test.key"; <.>

ssl_verify_client off;

ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";

ssl_protocols TLSv1.2;
ssl_session_cache  builtin:1000  shared:SSL:10m;

ssl_prefer_server_ciphers   on;
include includes/ds-*.conf;
}
----
<.> Адрес сервера документов Р7-Офис/OnlyOffice. Сервер документов должен быть доступен из того же доменного имени из-за CORS политик браузера.
<.> Путь к файлу `r7cert.crt`.
<.> Путь к файлу `r7cert.key`.
+
. Перезапустите службу *Р7-Офис. Сервер документов Proxy*/OnlyOffice.
+
.Служба "Р7-Офис. Сервер документов Proxy"
image::service-restart.png[Служба "Р7-Офис. Сервер документов Proxy"]
+
. Проверьте действительность сертификата в браузере: перейдите по адресу `\https://localhost:8083/welcome`. Если настройка выполнена верно, появится сообщение "Сервер документов запущен".
+
.Сертификат действителен
image::validity.png[Сертификат действителен]
+
[NOTE]
====
Чтобы избежать ошибки с сертификатом на пользовательских машинах, потребуется либо локально установить сгенерированный сертификат, либо перейти на URL сервера документов, например, `\https://r7team.com:8083/` и там выбрать перейти на сайт.
====
+
. В файле `C:\Program Files\R7-Office\DocumentServer-IE\config\local.json` задайте для параметров `inbox`, `outbox` и `browser` значение `false`.
. Добавьте входящее правило для порта в брандмауэр.

[#webc-config]
== Конфигурация {wc}а

. Откройте конфигурационный файл {wc}а по адресу `{webconfig}` в любом текстовом редакторе и отредактируйте следующие параметры:
+
// tag::webconfig[]
+
[source,json]
----
  "Docsvision": {
    "WebClient": {
      "SettingGroups": {
        "WebClient": {
          "ServerR7ConnectionAddress": "http://dvserver.preview.com", <.>
          "FilePreviewMode": "0" <.>
        }
      }
    }
  }
----
<.> `ServerR7ConnectionAddress` -- url сервера документов Р7-Офис/OnlyOffice. Настройка обязательна для заполнения. Если url сервера документов Р7 не указан, вторая настройка будет проигнорирована и будет использоваться стандартный инструмент предварительного просмотра pdf.js.
<.> `FilePreviewMode` -- определяет, какой компонент используется для предпросмотра. Значения: `0` -- предпросмотр отключен, `1` -- предпросмотр с помощью р7.
// end::webconfig[]
+
. Переключите Web-клиент на использование `https://`.

// [#secure]
// include::.connect-https.adoc[leveloffset=+2]
