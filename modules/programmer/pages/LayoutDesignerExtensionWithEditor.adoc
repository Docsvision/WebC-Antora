= Добавление редактора для значения свойства элемента управления

Редактор предоставляет пользовательский интерфейс для изменения значения свойства в программе {kvr}.

Новый редактор нужно разрабатывать, когда требуется поддержать возможность изменения свойства со сложным типом значения, предоставить новый пользовательский интерфейс для изменения свойства или изменить логику работы со значением свойства.

Редактор представляет собой элемент управления с типом `System.Windows.Controls.UserControl`, в котором реализован интерфейс `Xceed.Wpf.Toolkit.PropertyGrid.Editors.ITypeEditor`. Рекомендуемые размеры элемента управления: 20x200px. Если для изменения значения свойства требуется форма большего размера, разработайте её в отдельном компоненте с типом `System.Windows.Window`, а в основной компонент UserControl добавьте функцию, вызывающую данную форму.

Добавить новый редактор в {kvr} можно с помощью Расширения.

. link:LayoutDesignerExtensionNew.md[Создайте проект расширения программы {kvr}].

. Добавьте в проект компонент с типом UserControl (WPF) и реализуйте в нем программный интерфейс https://xceed.com/wp-content/documentation/xceed-toolkit-plus-for-wpf/Xceed.Wpf.Toolkit~Xceed.Wpf.Toolkit.PropertyGrid.Editors.ITypeEditor.adoc[ITypeEditor].

Следующий код демонстрирует пример класса редактора.

```csharp
 public partial class SuperEditor : UserControl, ITypeEditor
 {
 // Переменные для хранения текущего значения свойства и его программного компонента (PropertyItem)
 private string startValue;
 private PropertyItem propertyItem;

----
   public SuperEditor()
   {
       InitializeComponent();
   }

   // Реализация единственного метода интерфейса ITypeEditor
   // Метод должен вернуть элемент управления, который будет отображаться на панели Свойства
   public FrameworkElement ResolveEditor(PropertyItem prop)
   {
       // Сохраняем ссылку на компонент свойства, для возможности сохранения изменения свойства
       propertyItem = prop;

       // Поле prop.Value содержит значение элемента управления
       if (prop.Value == null)
           prop.Value = string.Empty;

       startValue = prop.Value.ToString(); // Значение свойства передается в prop.Value

       Placeholder.Text = "{lines ...}"; // Текст, который будет отображаться в качестве значения свойства

       // В качестве элемента управления для отображения на панели свойства используется текущий элемент управления
       return this;
   }

   // Открытие диалогового окна редактирования значения свойства
   private void ChangeLines_Click(object sender, RoutedEventArgs e)
   {
      var dialog = new DialogEditor(startValue);
      dialog.ShowDialog();

      // Новое значение получаем из переменной Value
      // Значение должно быть сохранено в propertyItem.Value
      propertyItem.Value = startValue = dialog.Value;
   }
----

}

```

В данном случае редактор представляет собой кнопку *ChangeLines*, при нажатии которой открывается диалоговое окно *DialogEditor* для ввода текстового значения, а также нередактируемый блок текста *Placeholder* для отображения статичного значения «{lines …}». Ниже приведен код графической части редактора.

```xml
 &lt;UserControl x:Class="TemplateDesignerExtension1.Editors.SuperEditor"
 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 xmlns:local="clr-namespace:TemplateDesignerExtension1.Editors"
 mc:Ignorable="d"
 d:DesignHeight="20" d:DesignWidth="200"&gt;
 <Grid>
 &lt;TextBlock x:Name="ValueString" HorizontalAlignment="Left" Margin="1" VerticalAlignment="Stretch" Width="164"/&gt;
 &lt;Button x:Name="ChangeLines" Content="…" HorizontalAlignment="Right" Margin="1" VerticalAlignment="Top" Width="22" Click="ChangeLines_Click" /&gt;

----
   </Grid>
----

</UserControl>
 ```

Собственная реализация редактора может включать любые элементы управления и использоваться для отображения любых значений (с учетом рекомендуемых значений элемента управления).

Значение свойства можно получить из переменной `propertyItem.Value`. При изменении значения, его нужно сохранить в `propertyItem.Value`. 

. Переопределите метод GetEditors базового класса расширения, чтобы он возвращал коллекцию с парой: ключ -- имя, по которому можно получить данный редактор; значение -- тип редактора:

`csharp
   protected override Dictionary&lt;string, Type&gt; GetEditors()
   {
       return new Dictionary&lt;string, Type&gt;
       {
           { &quot;SuperEditor&quot;, typeof(Editors.SuperEditor) }
       };
   }
`

. Скомпилируйте проект и скопируйте полученную сборку на сервер {wc}а в папку `&lt;Каталог установки {wc}а&gt;\Plugins\\&lt;Каталог Решения&gt;`. Ресурсные сборки скопируйте в папки `&lt;Каталог установки {wc}а&gt;\ru\` (для русской локализации), `&lt;Каталог установки {wc}а&gt;\uk\` (для английской локализации) и т.д.

. Перезапустите {kvr}.

== Проверка примера

. link:LayoutDesignerExtensionWithProperty.md[Создайте новое свойство] элемента управления в расширении с _Супер редактором_.

. Укажите _Супер редактор_ в качестве редактора свойства в параметре *Editor*.

```csharp
 PropertyDescription GetSuperPropertyDescription()
 {
 var propertyDescription = new PropertyDescription();
 propertyDescription.Name = "SuperProperty";
 propertyDescription.Type = typeof(string); // Тип свойства должен быть string!
 propertyDescription.Category = PropertyCategoryConstants.DataCategory;
 propertyDescription.DisplayName = "Супер свойство";

----
   propertyDescription.Editor = typeof(SuperEditor); // Указываем тип «Супер редактора»
   return propertyDescription;
----

}
 ```

. Добавьте свойство с редактором _Супер редактор_ в описатель элемента управления. См. пример в пункте link:LayoutDesignerExtensionWithProperty.md[Добавление нового свойства элементов управления].

. Опубликуйте расширение с элементом управления на сервере {wc}а.

. Откройте для настройки любую разметку.

. Добавьте в разметку элемент управления, содержащий свойство с редактором. Для изменения значения свойства будет использован «Супер редактор».

image:img/propertyEditor.png["Супер свойство с собственным редактором"]

Изменение значения свойства осуществляется в диалоговом окне, открываемом при нажатии кнопки *…*.

image:img/propertyEditorForm.png[Диалоговое окно изменения значения свойства]