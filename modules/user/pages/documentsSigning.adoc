= Работа с электронными подписями в карточках типа "Документ"

== Произвольное подписание документов

Пользователь может подписать электронной подписьюfootnote:[Определяется настройками вида документа.] (ЭП): основные и дополнительные файлы, атрибуты документа.

Подписание выполняется с целью защиты данных карточки от изменений, после изменения данных ЭП станет недействительной.

Документ может быть подписан простой, усиленной или квалифицированной ЭП. Возможность подписания тем или иным видом ЭП регулируется настройками системы {dv}, а также наличием необходимых программных средств на компьютере пользователя.

.Ограничения подписания
****
include::ROOT:page$requirementsSignature.adoc[tags=expiredCryptoPro]

include::partial$excerpts.adoc[tags=35mb]

include::partial$excerpts.adoc[tags=appRequired]
****

.Чтобы подписать документ:
. Откройте карточку документа в xref:cardsOpenModes.adoc#openInReadMode[режиме чтения].
. В разделе _Файлы_ нажмите image:buttons/signatureFile.png[Прозрачная печать] *> Подписать*.
+
.Подписание документов
image::fileSignature.png[Подписание документов]
+
На экране появится окно _Электронная подпись_.
+
.Параметры электронно-цифровой подписи
image::fileSignatureLabelSelect.png[Параметры электронно-цифровой подписи]
+
. Выберите метку для подписи.
+
****
Метки конкретизируют решение сотрудника, подписавшего карточку документа.

Если метки отсутствуют (в _Справочнике меток подписей_), поле выбора метки не отображается.
****
+
. Выберите вариант подписания:
* *_Простая подпись_* -- документ будет подписан учетной записью сотрудника.
+
TIP: Функция может быть недоступна, если простая подпись запрещена настройками карточки.
* *_Выберите сертификат_* -- документ будет подписан усиленной подписью.
+
TIP: Чтобы иметь возможность подписать документ усиленной подписью, необходимо установить компоненты xref:prepareInstallAdditionalComponents.adoc#cryptoPro[КриптоПро].
+
.Варианты подписания
****
Выбор варианта подписания зависит от настроек _Справочника сотрудников_ и наличия действительных сертификатов в персональном хранилище пользователя:

.Компоненты для работы с усиленной ЭП, не установлены:
- В окне будет отображаться подсказка: `Не установлен компонент для использования усиленной подписи` и в списке будет доступен только вариант *_Простая подпись_*.

.Компоненты для работы с усиленной ЭП, установлены:
* Если в персональном хранилище есть только один действительный сертификат, в списке вариантов подписания будут присутствовать этот сертификат и *_Простая подпись_*.
* Если сертификат не совпадает с указанным в справочнике сотрудников, в дополнение к сертификату и *_Простой подписи_* будет отображаться предупреждающее сообщение: `Сертификат в персональном хранилище не совпадает с указанным в Справочнике сотрудников`.
* Если в персональном хранилище у пользователя есть несколько сертификатов, в списке будут присутствовать варианты:
** *_Простая подпись_*,
** Название сертификата из _Справочника сотрудников_, если он указан и найден в хранилище
** *_Выберите сертификат_*. Открывает окно выбора сертификата из списка действительных, установленных в персональном хранилище.
+
.Окно выбора сертификата для подписания
image::certList.png[Окно выбора сертификата для подписания]
+
* Если в хранилище сертификатов нет, в окне будет отображено соответствующее сообщение.
+
TIP: Квалифицированные сертификаты выделяются жирным.
****
+
. Если для наложения усиленной подписи требуется выбрать сертификат, кликните по строке с информацией о нём.
. Нажмите на кнопку *Подписать*.
+
****
После подписания появится сообщение `Электронная подпись сформирована успешно`. Цвет значка image:buttons/signatureFile.png[Прозрачная печать] сменится на чёрный.

Ознакомиться с информацией о подписях документа можно в xref:documentsSigning.adoc#signatureLog[журнале наложенных подписей].
****

[#signatureLog]
== Журнал электронно-цифровых подписей

. Откройте карточку документа в xref:cardsOpenModes.adoc#openInReadMode[режиме чтения].
. В разделе _Файлы_ нажмите image:buttons/signatureBlack.png[Заполненная печать] *> Журнал подписей*.
+
****
Будет открыто окно со списком подписей и результатами их проверки.
****
+
.Отображение списка наложенных подписей
image::fileSignatureCheck.png[Отображение списка наложенных подписей]

== Окно "журнал подписей"

Окно _Журнал подписей_ содержит два раздела:

Список подписей::
Перечень электронных подписей в данном документе.
+
Список включает следующую информацию:
+
- ФИО подписанта.
+
Если подписант присутствует в справочнике, данные берутся из _Справочника сотрудников_. Если подписант отсутствует в справочнике, данные берутся из подписи.
- Метку подписи.
- Дату подписания.
- Вид подписи. Подписание документа или импортированная подпись.
- Тип подписи. Простая или усиленная.
- Значок и результат проверки подписи.

+
****
Для подписи, xref:documentsSigning.adoc#loadDetachedSignature[импортированной из файла], в списке отображается также информация из данной загруженной подписи. В поле _Вид подписи_ у такой подписи будет указано значение _Импортированная подпись_.

Если ЭП была загружена в карточку, содержащую больше одного подписанного основного файла, результат проверки загруженной подписи будет смешанным: `Не все основные файлы подписаны`. При этом в разделе _Состав подписи_ положительный результат проверки будет только у файла, для которого была загружена отсоединённая подпись.
****

Состав подписи::
Информация о частях подписи, выбранной в списке подписей. Нажмите на строку подписи в списке, чтобы просмотреть её состав.
+
--
.Подпись может включать следующие части:
- Подписанные основные файлы с указанием версии.
- Подписанные дополнительные файлы.
- Подписанные атрибуты документа, если их подписание настроено.
--
+
.Для каждой части отображаются:
* Название подписанного элемента.
* Штамп времени.
* Вид подписи.
* Тип подписи.
* Результат проверки данной части подписи.

[#signatureValidation]
== Результаты проверки подписи

Для подписи могут отображаться следующие виды результатов проверки:

Подпись верна::
Все текущие версии основных файлов подписаны и подписи верны.

Подпись не верна::
Все текущие версии основных файлов подписаны, но подписи не верны.

Не все основные файлы подписаны::
Подписаны не все текущие версии основных файлов. Присутствуют как подписанные, так и не подписанные файлы. Такая ситуация возможна, когда после наложения подписи были добавлены новые основные файлы.

Если была наложена квалифицированная усиленная ЭЦП, в списке подписей будет присутствовать информация о типе подписи и штампе времени.

Если в результате проверки выяснится, что усиленная подпись не верна, в журнале будет указана причина:

* `Срок действия сертификата истек`.
* `Не удалось проверить сертификат`.
* `Файлы были изменены`.

Все возможные варианты результата проверки подписи представлены в таблице.

.Результаты проверки подписи
[cols="25%,25%,25%,25%", options="header"]
|===
|Результаты проверки подписи
|Суммарный статус подписи
|Статус валидных частей подписи
|Статус НЕ валидных частей подписи

4+|Сертификат валиден либо используется простая подпись:

|Все файлы, атрибуты подписаны и подписи валидны
|Подпись верна
|Подпись верна
|-

|Файлы, атрибуты подписаны, но результат проверки отрицательный (данные изменены)
|Подпись не верна
|Подпись верна
|Подпись не верна

|Подписи валидны, но присутствуют части подписи не для всех файлов документа
|Подписаны не все файлы
|Подпись верна
|Не подписан

4+|Сертификат не валиден или не проверен:

|Не удалось проверить сертификат
|Подпись не проверена (Не удалось проверить сертификат)
|-
|-

|Сертификат отозван
|Подпись не верна (Сертификат отозван)
|-
|-

|Срок действия сертификата истек
|Подпись не верна (Срок действия сертификата истек)
|-
|-
|===

=== Срок действия и расширенная информация о подписи

Для квалифицированной электронной подписи в журнале подписей отображаются две дополнительные колонки.

В колонке _Штамп времени_ отображается точная дата подписания документа. В колонке _Срок действия_ отображается дата устаревания штампа электронной подписи.

Сервис перештамповки, входящий в модуль _{dv} 5 Базовые Объекты_ версии 5.5.4, открывает возможность просмотра расширенной информации о подписи.

.Расширенная информация о наложенном штампе квалифицированной подписи
image::fileSignatureCheckExtended.png[Расширенная информация о наложенном штампе квалифицированной подписи]

Если сервис перештамповки доступен, рядом с результатом проверки подписи появляется иконка image:buttons/infoBlueCircle.png[Информация]. При нажатии на иконку выводится расширенная информация о сертификате и штампе времени подписи.

.Информация о сертификате:
- Тип подписи,
- Кому выдан (ФИО или организация),
- Кем выдан,
- Срок действия сертификата

.Информация о штампе времени:
- Тип штампа,
- дату добавления,
- Кем выдан,
- Срок действия.

TIP: Самый близкий к текущей дате штамп времени выводится сверху.

== Распечатать документ со штампом электронной подписи

{wc} позволяет печатать файлы, приложенные к карточке со штампом электронной подписи. Данная возможность доступна только для основных файлов форматов `.pdf`, `.doc`, `.docx` и `.xlsx` с <<signatureValidation,действительной>> ЭП (подпись верна). Файлы должны быть подписаны с помощью сертификата, возможность печати штампа для простой подписи не предусмотрена.

.Чтобы распечатать документ со штампом ЭП:
. Откройте документ, содержащий подписанный файл.
. В меню основного файла нажмите image:buttons/verticalDots.png[Три вертикальные точки] *> Показать с ЭП*.
+
.Меню печати штампа электронной подписи
image::printDigitalSignatureStamp.png[Меню печати штампа электронной подписи]
+
Будет сформирован файл PDF с содержимым печатаемого файла и штампом электронной подписи. Если файл подписан несколькими усиленными или квалифицированными подписями, штампы всех подписей будут представлены в печатной версии.
+
.Пример файла со штампом электронной подписи
image::fileWirhDSStamp.png[Пример файла со штампом электронной подписи]
+
Штамп ЭП включает в себя метку подписи, номер, срок действия и владельца сертификата ЭП, а также логотип, xref:admin:configDigitalSignatureStamp.adoc[который может быть настроен].
+
Штампы можно перемещать в пределах страницы `.pdf` файла, а также изменять их размеры. Данная возможность должна поддерживаться используемым средством просмотра `.pdf` файлов.

[#exportSignedFiles]
== Экспортировать файлы с подписями

Подписанные основные файлы можно сохранить на устройство пользователя вместе с электронными подписями.

NOTE: Чтобы экспортировать файлы с подписями, необходимо обладать правами на скачивание файлов карточки.

. xref:cardsOpenModes.adoc[Откройте карточку] документа в xref:cardsOpenModes.adoc#openInReadMode[режиме чтения].
. В разделе _Файлы_ нажмите image:buttons/exportFilesWithSign.png[пачка листов с печатью].
+
TIP: Кнопка недоступна, если в карточке отсутствуют подписанные основные файлы.
+
****
На устройство пользователя будет сохранён `.zip` архив, содержащий текущие версии подписанных основных файлов с файлами отсоединённых электронных подписей. Основные файлы и отсоединённые подписи будут сгруппированы по папкам.

Экспортируются только <<signatureValidation,действительные>> подписи текущих версий основных файлов.
****

[#loadDetachedSignature]
== Загрузить отсоединённую электронную подпись файла

{wc} поддерживает возможность загрузки отсоединённой электронной подписи в карточку Документа для подписания основного файла.

https://ca.kontur.ru/articles/ecp-terminy[Отсоединённая ЭП] -- файл формата `.p7s`, `.sig`, `.sgn` или `.sign`, содержащий электронную подпись подписанного файла. Отсоединённая ЭП может быть загружена с использованием кодировки `DER` или `BASE-64`.

[NOTE]
====
{wc} поддерживает загрузку отсоединённых подписей только основных файлов.
====

.Чтобы загрузить отсоединённую подпись:
. Откройте карточку Документ, в которую загружается отсоединённая подпись.
. Перейдите к разделу _Файлы_.
. Загрузите электронную подпись:
+
--
.Если карточка Документ содержит файл, для которого загружается отсоединённая подпись:
.. В строке основного файла, для которого загружается подпись, нажмите image:buttons/verticalDots.png[Три вертикальные точки] *> Загрузить ЭП*.
.. Выберите файл отсоединённой подписи (`.p7s`, `.sig`, `.sgn`, `.sign`).
.. Нажмите *Открыть*, чтобы загрузить выбранные файлы.
--
+
.Если файл с отсоединённой подписью загружается вместе с подписью:
.. Нажмите image:buttons/attachFile.png[Папка] *> +Основной*.
.. Выберите подписанный файл и файл, содержащий отсоединённую подпись (.p7s`, `.sig`, `.sgn`, `.sign`).
.. Нажмите *Открыть*, чтобы загрузить выбранные файлы.

В атрибуте _Имя файла_ отсоединённой электронной подписи должно содержаться название файла, которому принадлежит данная подпись, иначе загрузка будет невозможна.

Возможность загрузки электронной подписи будет недоступна, если запрещена xref:layouts:ctrl/special/fileList.adoc#editOperationToAddSignature[операция редактирования] для добавления подписи.

Если карточка Документ содержит файл с отсоединённой подписью или файл был загружен вместе с отсоединённой подписью, подпись будет прикреплена к этому файлу. Подпись прикрепляется к текущей версии основного файла. Проверить, к какому файлу прикреплена подпись можно с помощью xref:documentsSigning.adoc#signatureLog[журнала электронно-цифровых подписей].

Если файл, к которому должна быть присоединена подпись, отсутствует в Документе, будет выдано сообщение о невозможности загрузки подписи. Другие файлы, выбранные при загрузке, будут загружены при наличии прав.

Если присоединяемая подпись недействительна, будет выдано сообщение об ошибке. Подпись загружена не будет.

Если оставшийся срок действия сертификата подписи составляет менее 5 дней, будет выдано предупреждение: `Срок действия сертификата закончится <Дата>`. Пользователь может подтвердить или отменить загрузку подписи.

Если выбран файл с *присоединённой* электронной подписью (файл-контейнер, содержащий и подписанный файл и электронную подпись), будет выдано предупреждение: `Необходимо использовать отсоединенную подпись`.
