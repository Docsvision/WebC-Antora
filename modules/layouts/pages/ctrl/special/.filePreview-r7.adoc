:dispatch: Диспетчер служб IIS
:wc: Web-клиент

= Предпросмотр файлов при помощи "Р7-Офис. Сервер документов"

Для ЭУ `_Предпросмотр файла_` добавлена возможность предварительного просмотра при помощи "Р7-Офис. Сервер документов".

Данная реализация позволяет отображать предпросмотр не печатной версии документа, а непосредственно файл. Например, для документа Excel появляется возможность скопировать данные из файла с сохранением структуры и форматирования. Все прежние функции поддерживаются как в стандартной реализации.

== Настройка "Р7-Офис. Сервер документов"

.Чтобы активировать новый режим предварительного просмотра, выполните шаги следующей инструкции:
. Скачайте и установите сервер документов https://r7-office.ru/downloadserver_doc[по ссылке]. Инструкция по установке доступна по той же ссылке.
+
Указанные выше компоненты можно установить при помощи https://r7-office.ru/downloadserver[инсталлятора]. Достаточно установить только эти компоненты, сам корпоративный сервер устанавливать не нужно.
+
. Откройте диспетчер серверов IIS. На начальной странице выберите _Сертификаты сервера_.
+
.Начальная страница диспетчера серверов IIS
image::server-certificates.png[Начальная страница диспетчера серверов IIS]
+
. На странице _Сертификаты сервера_ выберите *Создать самоподписанный сертификат*.
+
."Создать самоподписанный сертификат"
image::self-signed.png["Создать самоподписанный сертификат"]
+
. Укажите имя сертификата, нажмите *ОК*.
+
.Укажите имя сертификата
image::cert-name.png[Укажите имя сертификата]
+
. Правой кнопкой мыши нажмите на созданный сертификат, в контекстном меню выберите _Экспортировать_.
+
.Экспортируйте сертификат
image::export-cert.png[Экспортируйте сертификат]
+
. В появившемся окне укажите путь для сохранения сертификата и задайте пароль.
+
.Укажите путь для сохранения сертификата и задайте пароль
image::cert-creds.png[Укажите путь для сохранения сертификата и задайте пароль]
+
. Скачайте и установите утилиту https://slproweb.com/products/Win32OpenSSL.html[OpenSSL].
. Запустите Win64 OpenSSL Command Prompt от имени администратора, перейдите в директорию, в которой располагается файл `r7-cert.pfx`
. Выполните команду:
+
 $ openssl pkcs12 -in ./r7cert.pfx -clcerts -nokeys -out r7cert.crt
+
Введите пароль.
+
Будет создан файл `r7cert.crt`.
+
. Выполните команду:
+
 $ openssl pkcs12 -in ./r7cert.pfx -nocerts -nodes -out r7cert.key+
Введите пароль.
+
Будет создан файл `r7cert.key`.
+
. В файле `ds.conf` по адресу `C:\Program Files\R7-Office\DocumentServer-IE\nginx\conf` укажите путь до созданных сертификата и ключа по следующему шаблону:
+
[source]
----
include includes/http-common.conf;
server {
listen 0.0.0.0:8083 ssl;
listen [::]:8083 ssl default_server;
server_tokens off;

set $secure_link_secret oLERiDD4bc309MFWvy3B;
root /usr/share/nginx/html;

ssl on;
ssl_certificate "C:/certificates/r7test.crt"; <.>
ssl_certificate_key "C:/certificates/r7test.key"; <.>

ssl_verify_client off;

ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";

ssl_protocols TLSv1.2;
ssl_session_cache  builtin:1000  shared:SSL:10m;

ssl_prefer_server_ciphers   on;
include includes/ds-*.conf;
}
----
<.> Путь к файлу `r7cert.crt`.
<.> Путь к файлу `r7cert.key`.
+
. Перезапустите службу *Р7-Офис. Сервер документов Proxy*.
+
.Служба "Р7-Офис. Сервер документов Proxy"
image::service-restart.png[Служба "Р7-Офис. Сервер документов Proxy"]
+
. Проверьте действительность сертификата в браузере: перейдите по адресу `\https://localhost:8083/welcome`. Если настройка выполнена верно, появится сообщение "Сервер документов запущен".
+
.Сертификат действителен
image::validity.png[Сертификат действителен]
+
[NOTE]
====
Чтобы избежать ошибки с сертификатом на пользовательских машинах, потребуется либо локально установить сгенерированный сертификат, либо перейти на URL сервера документов, например, `\https://r7team.com:8083/` и там выбрать перейти на сайт.
====
+
. В файле `C:\Program Files\R7-Office\DocumentServer-IE\config\local.json` задайте для параметров `inbox`, `outbox` и `browser` значение `false`.
. Добавьте входящее правило для порта в брандмауэр.

== Конфигурация {wc}а

. В конфигурационном файле {wc}а добавьте следующие параметры:
+
* `ServerR7ConnectionAddress` -- url сервера документов Р7. Настройка обязательна для заполнения. Если url сервера документов Р7 не указан, вторая настройка будет проигнорирована и будет использоваться стандартный инструмент предварительного просмотра pdf.js.
* `FilePreviewMode` - определяет, какой компонент используется для предпросмотра. Значения: `0` — стандартный pdf.js, `1` — новый р7.
+
. Переключите Web-клиент на использование `https://`.

=== Использование защищённого подключения

[#create-cert]
.Создайте сертификат:
. Откройте _{dispatch}_.
. На начальной странице выберите _Сертификаты сервера_.
+
Будет открыто окно выбора доступных сертификатов. Вам необходимо создать новый сертификат.
. В области _Действия_ выберите *Создать самозаверенный сертификат*.
+
[NOTE]
====
Если у вас уже есть сертификат, выданный центром сертификации или компанией, вы можете его *Импортировать*. Вы также можете *Создать запрос сертификата* согласно https://www.ssl.com/ru/%D0%BA%D0%B0%D0%BA/%D1%81%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%B8-%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82%D0%B0-csr-%D0%B2-iis-10/[инструкции онлайн]. В последнем случае обратите внимание на следующее <<mind-this,примечание>>.
====
+
. В открывшемся окне введите понятное имя сертификата и нажмите *ОК*.
+
Сертификат будет создан и автоматически помещён в хранилище.

[start=5]
.Настройте привязки:
. Перейдите на сайт DocsVision в IIS. Например, Default Web Site.
. Справа в области _Действия_ выберите *Привязки*.
. В появившемся окне нажмите *Добавить*.
. Выберите _Тип_: *_https_*. Поставьте _IP-адрес_ в значение *_"Все неназначенные"_*, укажите `Порт` 443.
. В поле `Имя узла` введите адрес подключения к {wc}у.
. Выберите SSL-сертификат, созданный ранее из списка или, нажав на кнопку *Выбрать*. Нажмите *ОК*.
. Повторите шаги 1 -- 6, если требуется задать привязки для нескольких адресов.

[#mind-this]
[CAUTION]
Данная настройка не исключает возможности подключения по HTTP. Если вы хотите, чтобы клиенты могли работать в {wc}е только по HTTPS, выполните шаги из пункта <<limit-http>>.


[#limit-http]
[start=12]
.Ограничьте использование HTTP:
. Перейдите на сайт {wc}а в IIS. По умолчанию DocsVisionWebClient.
. В окне выберите "Параметры SSL".
. Поставьте флаг `*Требовать SSL*`. В списке `*Сертификаты клиента*` выберите *Принимать*.
. В области _Действия_ справа нажмите *Применить*.
+
Будут сохранены настройки. Убедитесь, что клиенты уведомлены о необходимости вводить адрес через *http__s__*. В противном случае при вводе адреса {wc}а через *http* клиенты получат ошибку.
+
. Откройте {pu}.
. На панели управления {wc} выберите раздел _"{wc}"_ и нажмите *Обновить* напротив адреса {wc}а.
+
[WARNING]
====
При настройке Параметров SSL в диспетчере IIS не устанавливайте флаг `*Требовать SSL*` для Default Web Site или сайта DocsVision. Если установить флаг для этих сайтов, Windows клиент и другие модули будут требовать защищённое подключение. Понадобится настроить адрес сервера в Консоли настройки DocsVision см. Руководство Администратора модуля {pl}, раздел Настройки сервера. Адрес подключения понадобится также сменить на всех клиентских машинах.
====
