
== Особенности настройки кластера {wc}

С целью повышения отказоустойчивости и распределения нагрузки, администратор может объединить несколько экземпляров модуля {wc} в кластер.

*Обязательные условия* для работы кластера:

. Каждый экземпляр Модуля должен иметь собственный (уникальный) адрес подключения.
. На узлах кластера должен использоваться один сертификат шифрования.
. Балансировщик нагрузки должен передавать заголовок "X-Forwarded-Proto".

Чтобы подготовить узлы кластера {wc} к работе, нужно выполнить следующие действия:

. [.ph .cmd]#xref:task_install_dvextension.adoc[Установить серверное расширение {wc}] на сервер {dv}.#
. [.ph .cmd]#xref:task_install_webclient.adoc[Установить] и xref:task_initial_configuration.adoc[настроить] модуль {wc} на первом компьютере кластера (далее – [.keyword]*УЗЕЛ 1*).#
. [.ph .cmd]#Найти в конфигурационном файле {wc}а УЗЛА 1 отпечаток используемого Модулем сертификата (потребуется при настройке второго и последующих узлов кластера). Для этого:#
[loweralpha]
.. [.ph .cmd]#Открыть конфигурационный файл[.ph]##[.ph .filepath]`{webconfig}`## на УЗЛЕ 1.#
.. [.ph .cmd]#Перейти к настройке [.ph .menucascade]#[.ph .uicontrol]*configuration* > [.ph .uicontrol]*microsoft.identityModel* > [.ph .uicontrol]*service* > [.ph .uicontrol]*serviceCertificate* > [.ph .uicontrol]*certificateReference*#.#
+
[source,,l]
----
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
 <microsoft.identityModel>
  <service>
   <serviceCertificate>
    <certificateReference x509FindType="FindByThumbprint" findValue="B4369FA8D1B0A1B502CB916509317E9C6077CC69" />
   </serviceCertificate>
  </service>
 </microsoft.identityModel>
</configuration>
----
.. [.ph .cmd]#Искомый отпечаток сертификата записан в значении атрибута `findValue` (в примере – значение «B4369FA8D1B0A1B502CB916509317E9C6077CC69»).#
. [.ph .cmd]#Выгрузить сертификат с найденным на шаге 3 отпечатком в файл. Для этого:#
[loweralpha]
.. [.ph .cmd]#Выбрать на компьютере меню [.ph .menucascade]#[.ph .uicontrol]*Пуск* > [.ph .uicontrol]*Выполнить*#.#
.. [.ph .cmd]#Ввести команду [.keyword]*mmc* и нажать [.ph .uicontrol]*ОК*.#
.. [.ph .cmd]#Выбрать меню [.ph .menucascade]#[.ph .uicontrol]*Файл* > [.ph .uicontrol]*Добавить или удалить оснастку*#.#
.. [.ph .cmd]#Выбрать из списка оснастку «Сертификаты» и нажать на кнопку [.ph .uicontrol]*Добавить*.#
.. [.ph .cmd]#В открывшемся окне установить переключатель на учетной записи компьютера, нажать на кнопку [.ph .uicontrol]*Далее* (настройки не изменять) и нажать на кнопку [.ph .uicontrol]*Готово*.#
.. [.ph .cmd]#Открыть раздел [.ph .menucascade]#[.ph .uicontrol]*Личное* > [.ph .uicontrol]*Сертификаты*#.#
+
image::certmgr.png[[.fig--title-label]##Figure 1. ##Консоль управления «Сертификаты». Хранилище «Личное»]
.. [.ph .cmd]#Найти сертификат, который выдан «{dv}» и имеет (см. данные сертификата) полученный на шаге 3 отпечаток.#
+
image::cert_thumbprint.png[[.fig--title-label]##Figure 2. ##Данные сертификата]
.. [.ph .cmd]#Нажать на кнопку [.ph .uicontrol]*Копировать в файл* и (следуя подсказкам мастера) экспортировать сертификат в файл в формате «X.509 в кодировке DER».#
+
+++Необходимо экспортировать приватный ключ+++.
. [.ph .cmd]#Установить и настроить модуль {wc} на втором компьютере кластера (далее – [.keyword]*УЗЕЛ 2*). #
+
[NOTE]
====
[.note__title]#Important:# Экземпляр {wc}а, установленный на втором и последующих узлах кластера, должен быть настроен на работу с сервером и базой данных {dv}, на работу с которыми настроен {wc} на УЗЛЕ 1.
====
. [.ph .cmd]#Изменить в конфигурационном файле Модуля на УЗЛЕ 2 значение отпечатка сертификата, указав полученное на шаге 3 значение. Для этого:#
[loweralpha]
.. [.ph .cmd]#Открыть конфигурационный файл [.ph]#[.ph .filepath]`{webconfig}`# на УЗЛЕ 2.#
.. [.ph .cmd]#Перейти к элементу [.ph .menucascade]#[.ph .uicontrol]*configuration* > [.ph .uicontrol]*microsoft.identityModel* > [.ph .uicontrol]*service* > [.ph .uicontrol]*serviceCertificate* > [.ph .uicontrol]*certificateReference*#.#
.. [.ph .cmd]#Изменить значение атрибута [.keyword]*findValue* на значение, которое было получено на шаге 3.#
.. [.ph .cmd]#Сохранить изменения конфигурационного файла.#
. [.ph .cmd]#Импортировать сертификат, который был получен на шаге 4, на компьютер УЗЛА 2. Для этого:#
[loweralpha]
.. [.ph .cmd]#Скопировать полученный на шаге 4 файл сертификата (.CER) на компьютер УЗЛА 2.#
.. [.ph .cmd]#Открыть контекстное меню файла .CER и выбрать команду [.ph .uicontrol]*Установить сертификат*.#
.. [.ph .cmd]#Установить переключатель расположения хранилища в значение «Локальный компьютер» и нажать [.ph .uicontrol]*Далее*.#
.. [.ph .cmd]#Установить переключатель [.ph .uicontrol]*Поместить все сертификаты в следующее хранилище*, выбрать хранилище «Личное» и нажать [.ph .uicontrol]*Далее*.#
.. [.ph .cmd]#Нажать [.ph .uicontrol]*Готово*.#
+
Сертификат будет добавлен в личное хранилище сертификатов.

Проверить корректность добавления сертификата можно повторив шаг 4 (+++без экспорта+++) на компьютере со вторым экземпляром Модуля. Если сертификат был добавлен корректно, в списке сертификатов в хранилище «Личное» будет присутствовать сертификат с отпечатком, полученным на шаге 3.
. [.ph .cmd]#Установить, настроить и повторить процедуру переноса сертификата для третьего и последующих экземпляров Модуля.#

* *xref:MakeDVWebToolForCluster.adoc[Настройка утилиты DVWebTool для работы в кластере]* +

*Parent topic:* xref:Administrator_functions.adoc[Функции администратора]
